# LAMMPS input script generated from a template.
# Modified from pARTn with FIRE minimization, MAMMASMIAS, 2022

variable threshold equal $uncertainty_threshold

# ---------- Initialize Simulation --------------------- 
clear 
units       metal 
dimension   3 
boundary    p p p 
atom_style  atomic

# Prevent LAMMPS from sorting atoms, which might confuse ARTn.
atom_modify sort 0 1


# ---------- Read in the starting configuration --------------------- 
read_data $configuration_file_path

$group_block

$mass_block

# ---------- Define Pair Style (MTP) ---------------------
# Let mlip-3 control AL in LAMMPS (halt + save extrapolative snapshots)
# this has to be on one line despite all common sense
pair_style mlip load_from=$mtp_potential_path extrapolation_control=true extrapolation_control:threshold_break=$uncertainty_threshold extrapolation_control:threshold_save=2 extrapolation_control:save_extrapolative_to=preselected.cfg
pair_coeff * *

# ---------- Define Interatomic Potential ---------------------

neighbor     2.0 bin 
neigh_modify delay 10 check yes 

# balance atoms per cpu
comm_style tiled
balance 1.1 rcb


#  ----------- Define interruption variable
# variable continue_run equal "v_max_unc < v_threshold"


# stop simulation if the threshold is violated
# fix extreme_extrapolation all halt 1 v_continue_run != 1


# ----------- OUTPUT DUMP
dump dump_id all yaml 1 dump.yaml id element x y z fx fy fz
dump_modify dump_id thermo yes
dump_modify dump_id element $elements_string

thermo 1
thermo_style custom step pe

dump uncertain_dump_id all yaml 1 uncertain_dump.yaml id element x y z fx fy fz
dump_modify uncertain_dump_id thermo yes
dump_modify uncertain_dump_id element $elements_string

dump_modify uncertain_dump_id skip no


# ----------- ARTn
plugin load $artn_library_plugin_path

fix artn_fix_id all artn dmax 5.0

timestep 0.001


# ---------- Run Minimization --------------------- 
reset_timestep 0 

min_style fire 


## ------ launch
minimize 1e-4 1e-5 5000 10000
